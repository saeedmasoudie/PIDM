name: Build Windows Executable with Nuitka

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üß∞ Install Visual Studio Build Tools (includes mspdbcore.dll)
        uses: ilammy/msvc-dev-cmd@v1

      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      - name: üõ†Ô∏è Compile with Nuitka
        shell: pwsh
        run: |
          python -m nuitka `
            main.py `
            --standalone `
            --windows-console-mode=disable `
            --enable-plugin=pyside6 `
            --include-qt-plugins=all `
            --noinclude-pytest-mode=nofollow `
            --noinclude-unittest-mode=nofollow `
            --nofollow-import-to=tkinter,test,pydoc,yt_dlp.extractor.lazy_extractors,yt_dlp.extractor.packtpub ^
            --include-data-dir=assets=assets `
            --windows-icon-from-ico=assets/icons/pidm_icon.ico `
            --output-dir=dist `
            --output-filename=PIDM `
            --windows-company-name="PIDM" `
            --windows-product-name="Python Internet Download Manager" `
            --windows-file-version=1.2.0 `
            --windows-product-version=1.2.0 `
            --remove-output `
            --assume-yes-for-downloads

      - name: ‚úÖ Verify dist/PIDM.exe exists
        run: |
          if not exist dist\PIDM.exe (
            echo "‚ùå PIDM.exe not found. Build failed."
            exit 1
          )

      - name: üìÇ Copy extra folders (assets, translations, bin)
        run: |
          mkdir build_output
          xcopy /E /I /Y dist\main.dist build_output\
          if exist assets xcopy /E /I /Y assets build_output\assets\
          if exist translations xcopy /E /I /Y translations build_output\translations\
          if exist bin xcopy /E /I /Y bin build_output\bin\

      - name: üì¶ Upload compiled build as artifact
        uses: actions/upload-artifact@v4
        with:
          name: PIDM-windows-build
          path: build_output
